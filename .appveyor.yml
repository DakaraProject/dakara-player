version: 1.7.0-dev-{build}

image:
  - Ubuntu
  - Visual Studio 2019

build: false

# restrict to branches
branches:
  only:
    - master
    - develop

environment:
  # setup tests matrix
  matrix:
    - PYTHON: "3.6"
    - PYTHON: "3.7"
    - PYTHON: "3.8"
    - PYTHON: "3.9"

for:
  - matrix:
      only:
        - image: Ubuntu

    cache:
      # enable cache for Python dependencies
      - "$HOME/.cache/pip"

    init:
      # load virtual env
      - "source $HOME/venv$PYTHON/bin/activate"

      # check current python version
      - "python --version"

    install:
      # the features used in setup.cfg require a recent enough version of setuptools
      - "python -m pip install --upgrade \"setuptools>=40.0\""

      # install dependencies for test
      - "python -m pip install -e \".[tests]\""

    test_script:
      # run tests
      - "python -m coverage run -m pytest -v tests/unit"

      # run commands
      - "python -m dakara_player --version"
      - "dakara-play --version"

      # run code formatting tests
      - "python -m black . --check"
      - "python -m flake8"

    after_test:
      # show coverage stats
      - "python -m coverage report -m"

      # upload coverage stats to codecov.io
      # codecov token is stored in appveyor settings
      - "python -m coverage xml"
      - "python -m codecov -X gcov --file coverage.xml"

    for:
      - matrix:
          only:
            - PYTHON: "3.9"

        install:
          # install system dependencies
          - "sudo apt-get -qq update"
          - "sudo apt-get install -y vlc mpv"

          # the features used in setup.cfg require a recent enough version of setuptools
          - "python -m pip install --upgrade \"setuptools>=40.0\""

          # install dependencies for test
          - "python -m pip install -e \".[tests]\""

          # check dependencies version
          - "vlc --version"
          - "mpv --version"

        test_script:
          # run tests
          - "python -m coverage run -m pytest -v"

          # run commands
          - "python -m dakara_player --version"
          - "dakara-play --version"

          # run code formatting tests
          - "python -m black . --check"
          - "python -m flake8"

  - matrix:
      only:
        - image: Visual Studio 2019

    cache:
      # enable cache for Python dependencies
      - "%LOCALAPPDATA%\\pip\\Cache"

    init:
      # check current python version
      - "py -%PYTHON% --version"

    install:
      # the features used in setup.cfg require a recent enough version of setuptools
      - "py -%PYTHON% -m pip install --upgrade \"setuptools>=40.0\""

      # install dependencies for test
      - "py -%PYTHON% -m pip install -e \".[tests]\""

    test_script:
      # run tests
      - "py -%PYTHON% -m coverage run -m pytest -v tests/unit"

      # run commands
      - "py -%PYTHON% -m dakara_player --version"

      # run code formatting tests
      - "py -%PYTHON% -m black . --check"
      - "py -%PYTHON% -m flake8"

    after_test:
      # show coverage stats
      - "py -%PYTHON% -m coverage report -m"

      # upload coverage stats to codecov.io
      # codecov token is stored in appveyor settings
      - "py -%PYTHON% -m coverage xml"
      - "py -%PYTHON% -m codecov -X gcov --file coverage.xml"

    for:
      - matrix:
          only:
            - PYTHON: "3.9"

        install:
          # install system dependencies
          - "cinst vlc mpv"

          # the features used in setup.cfg require a recent enough version of setuptools
          - "py -%PYTHON% -m pip install --upgrade \"setuptools>=40.0\""

          # install dependencies for test
          - "py -%PYTHON% -m pip install -e \".[tests]\""

          # refresh console
          - "refreshenv"

        test_script:
          # run tests
          - "py -%PYTHON% -m coverage run -m pytest -v"

          # run commands
          - "py -%PYTHON% -m dakara_player --version"

          # run code formatting tests
          - "py -%PYTHON% -m black . --check"
          - "py -%PYTHON% -m flake8"
